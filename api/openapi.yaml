openapi: 3.0.3
info:
  title: AdMesh Exchange Protocol (AMXP) API
  version: "0.1"
  description: >
    Reference AMXP endpoints operated by AdMesh. Any AMXP-compatible network can implement the same contracts.
servers:
  - url: https://api.admesh.example
components:
  securitySchemes:
    HMAC:
      type: apiKey
      in: header
      name: X-AMXP-Signature
  parameters:
    VersionHeader:
      name: X-AMXP-Version
      in: header
      required: true
      schema: { type: string, enum: ["0.1"] }
    NonceHeader:
      name: X-Nonce
      in: header
      required: true
      schema: { type: string }
    TsHeader:
      name: X-Timestamp
      in: header
      required: true
      schema: { type: string, format: date-time }
  schemas:
    ContextRequest:
      type: object
      required: [request_id, session_id, platform_id, query_text, locale, geo, ts, auth]
      properties:
        request_id: { type: string }
        session_id: { type: string }
        platform_id: { type: string }
        query_text: { type: string }
        surface: { type: string, enum: [chat, voice, page, result_card] }
        locale: { type: string }
        geo: { type: string }
        safety:
          type: object
          properties:
            age_gate: { type: boolean }
            pii: { type: boolean }
        pricing:
          type: object
          properties:
            cpx_floor: { type: string, description: "decimal string" }
        features:
          type: object
          properties:
            topic: { type: array, items: { type: string } }
            intent: { type: string }
            user_type: { type: string, enum: [human, agent] }
        ts: { type: string, format: date-time }
        auth:
          type: object
          properties:
            nonce: { type: string }
            sig: { type: string }
    Bid:
      type: object
      required: [bid_id, agent_id, context_id, wallet_id, bid_vector, ts, auth]
      properties:
        bid_id: { type: string }
        agent_id: { type: string }
        context_id: { type: string }
        wallet_id: { type: string }
        bid_vector:
          type: object
          required: [cpx]
          properties:
            cpx: { type: string }
            cpc: { type: string }
            cpa: { type: string }
        preferred_unit: { type: string, enum: [CPX, CPC, CPA] }
        creative:
          type: object
          properties:
            title: { type: string }
            body: { type: string }
            cta: { type: string }
            deeplink: { type: string, format: uri }
        caps:
          type: object
          properties:
            session: { type: integer }
            daily: { type: integer }
            geo_allow: { type: array, items: { type: string } }
        ts: { type: string, format: date-time }
        auth:
          type: object
          properties:
            nonce: { type: string }
            sig: { type: string }
    AuctionResult:
      type: object
      required: [auction_id, serve_token, winner, render, ttl_ms]
      properties:
        auction_id: { type: string }
        serve_token: { type: string }
        winner:
          type: object
          required: [agent_id, clearing_price_cpx, preferred_unit]
          properties:
            agent_id: { type: string }
            clearing_price_cpx: { type: string }
            preferred_unit: { type: string, enum: [CPX, CPC, CPA] }
        render:
          type: object
          required: [label, title, url]
          properties:
            label: { type: string, enum: ["[Ad]"] }
            title: { type: string }
            body: { type: string }
            cta: { type: string }
            url: { type: string, format: uri }
        ttl_ms: { type: integer }
    EventCPX:
      type: object
      required: [event_type, serve_token, session_id, platform_id, agent_id, wallet_id, pricing, ts]
      properties:
        event_type: { type: string, enum: [cpx_exposure] }
        serve_token: { type: string }
        session_id: { type: string }
        platform_id: { type: string }
        agent_id: { type: string }
        wallet_id: { type: string }
        pricing:
          type: object
          required: [unit, amount, currency]
          properties:
            unit: { type: string, enum: [CPX] }
            amount: { type: string }
            currency: { type: string }
        exposure_metadata:
          type: object
          properties:
            surface: { type: string }
            position: { type: integer }
            visibility_ms: { type: integer }
        ts: { type: string, format: date-time }
    EventCPC:
      type: object
      required: [event_type, serve_token, event_id, ts]
      properties:
        event_type: { type: string, enum: [cpc_click] }
        serve_token: { type: string }
        event_id: { type: string }
        s2s: { type: boolean }
        ts: { type: string, format: date-time }
    EventCPA:
      type: object
      required: [event_type, serve_token, conversion_id, ts]
      properties:
        event_type: { type: string, enum: [cpa_conversion] }
        serve_token: { type: string }
        conversion_id: { type: string }
        conversion_type: { type: string }
        order_value_cents: { type: integer }
        currency: { type: string }
        ts: { type: string, format: date-time }
    Balance:
      type: object
      properties:
        available_balance: { type: string }
        pending_balance: { type: string }
        currency: { type: string }
paths:
  /amxp/context:
    post:
      summary: Submit context for auction
      security: [{ HMAC: [] }]
      parameters: [ { $ref: '#/components/parameters/VersionHeader' }, { $ref: '#/components/parameters/NonceHeader' }, { $ref: '#/components/parameters/TsHeader' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ContextRequest' }
      responses:
        '200':
          description: Auction result
          content:
            application/json:
              schema: { $ref: '#/components/schemas/AuctionResult' }
  /amxp/bid:
    post:
      summary: Submit a bid
      security: [{ HMAC: [] }]
      parameters: [ { $ref: '#/components/parameters/VersionHeader' }, { $ref: '#/components/parameters/NonceHeader' }, { $ref: '#/components/parameters/TsHeader' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Bid' }
      responses:
        '202':
          description: Accepted
  /amxp/events:
    post:
      summary: Post CPX, CPC, or CPA event
      security: [{ HMAC: [] }]
      parameters: [ { $ref: '#/components/parameters/VersionHeader' }, { $ref: '#/components/parameters/NonceHeader' }, { $ref: '#/components/parameters/TsHeader' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/EventCPX'
                - $ref: '#/components/schemas/EventCPC'
                - $ref: '#/components/schemas/EventCPA'
      responses:
        '202':
          description: Accepted
  /ledger/{serve_token}:
    get:
      summary: Inspect ledger record for a serve token
      security: [{ HMAC: [] }]
      parameters:
        - { $ref: '#/components/parameters/VersionHeader' }
        - in: path
          name: serve_token
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Ledger record
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuctionResult' # or a LedgerRecord if you choose to expose it
  /platforms/{id}/balance:
    get:
      summary: Get platform balance
      security: [{ HMAC: [] }]
      parameters:
        - { $ref: '#/components/parameters/VersionHeader' }
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Current balance
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Balance' }
  /payouts/request:
    post:
      summary: Request monthly payout
      description: One request per 30 days. Only aged funds are eligible.
      security: [{ HMAC: [] }]
      parameters: [ { $ref: '#/components/parameters/VersionHeader' } ]
      responses:
        '202':
          description: Payout request accepted
