# Ledger Record Schema

## Overview
Final reservation-based ledger entry that records the reserved amount, actual billing, and revenue share for a `serve_token`.

## Required Fields
| Field | Type | Description |
|--------|------|-------------|
| `serve_token` | string | Token linking exposure → click → conversion |
| `session_id` | string | Conversation/session identifier |
| `auction_id` | string | Auction that produced the serve |
| `platform_id` | string | Platform identifier |
| `brand_agent_id` | string | Winning Brand Agent |
| `state` | string | Ledger state (`PENDING`, `EXPOSED`, `CLICKED`, `CONVERTED`, `FINALIZED`, `REFUNDED`) |
| `reserved_unit` | string | Unit reserved at auction (`CPX`, `CPC`, `CPA`) |
| `reserved_amount_cents` | integer | Amount held from the wallet (in cents) |
| `final_unit` | string | Unit actually billed (`CPX`, `CPC`, `CPA`) |
| `final_amount_cents` | integer | Actual charge applied (in cents) |
| `currency` | string | ISO currency code |
| `timestamps` | object | ISO timestamps for major lifecycle steps |

## Timestamps Object
| Field | Type | Description |
|--------|------|-------------|
| `auction` | string | When the auction completed |
| `exposure` | string | When exposure occurred |
| `click` | string | When click occurred |
| `conversion` | string | When conversion occurred |
| `finalized` | string | When ledger entry was finalized |

## Optional Fields
| Field | Type | Description |
|--------|------|-------------|
| `revenue_share` | object | Breakdown of platform/operator cents |
| `ext` | object | Vendor extensions |

## Revenue Share Object
| Field | Type | Description |
|--------|------|-------------|
| `platform_cents` | integer | Portion allocated to the platform |
| `operator_cents` | integer | Portion allocated to the operator |

## Example
```json
{
  "serve_token": "stk_abcxyz123",
  "session_id": "sess_001",
  "auction_id": "auc_981",
  "platform_id": "pf_openai_chat",
  "brand_agent_id": "ba_451",
  "state": "FINALIZED",
  "reserved_unit": "CPA",
  "reserved_amount_cents": 500,
  "final_unit": "CPC",
  "final_amount_cents": 120,
  "currency": "USD",
  "timestamps": {
    "auction": "2025-11-14T18:00:00Z",
    "exposure": "2025-11-14T18:00:01Z",
    "click": "2025-11-14T18:00:05Z",
    "conversion": "2025-11-14T18:03:00Z",
    "finalized": "2025-11-14T19:00:00Z"
  },
  "revenue_share": {
    "platform_cents": 30,
    "operator_cents": 90
  }
}
```

## Validation Rules
- Amount fields must be integers ≥ 0
- `state` must be one of the defined enum values
- `reserved_unit` and `final_unit` must each be `CPX`, `CPC`, or `CPA`
- All timestamps must be ISO 8601 date-time strings
