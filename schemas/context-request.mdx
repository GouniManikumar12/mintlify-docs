# Context Request Schema

## Overview
Normalized request that an Operator sends to subscribed Brand Agents when opening an auction. It includes the enriched intent, allowed creative formats, and an operator-signed auth block.

## Required Fields
| Field | Type | Description |
|--------|------|-------------|
| `context_id` | string | Unique ID for this auction request |
| `session_id` | string | Conversation/session identifier |
| `operator_id` | string | Identifier of the operator sending the request |
| `platform_id` | string | Upstream AI platform identifier |
| `query_text` | string | Operator-curated user query |
| `locale` | string | Locale (BCP 47, e.g., `en-US`) |
| `geo` | string | Country code (ISO 3166-1 alpha-2) |
| `intent.type` | enum | Intent class: `informational`, `commercial`, `transactional` |
| `allowed_formats` | array | Creative formats allowed: `weave`, `citation`, `product_card` |
| `timestamp` | string | ISO 8601 timestamp created by the operator |
| `auth.nonce` | string | Nonce for replay protection |
| `auth.sig` | string | Operator signature authenticating the request |

## Optional Fields
| Field | Type | Description |
|--------|------|-------------|
| `platform_surface` | string | Platform surface type: chat, voice, browser, extension, ui panel |
| `model` | string | AI model provided by platform (e.g., `gpt-4.3-mini`) |
| `messages` | array | Conversation history (user + assistant turns) |
| `verticals` | array | Normalized topical verticals, e.g., `["crm", "smb_software"]` |
| `intent.decision_phase` | enum | Funnel stage: `research`, `compare`, `decide`, `act` |
| `intent.context_summary` | string | Operator generated summary |
| `intent.turn_index` | integer | Conversation turn index |
| `latency_budget_ms` | integer | Platform latency budget in milliseconds |
| `user_id` | string | Anonymous hashed user ID for pacing & personalization |
| `conversation_id` | string | Conversation session from platform |
| `device_type` | string | Device type: `mobile`, `desktop`, `tablet` |
| `metadata` | object | Unified metadata with platform and operator data |

## Example
```json
{
  "context_id": "ctx_92fA1",
  "session_id": "sess_001",
  "operator_id": "admesh_operator",
  "platform_id": "openai_chat",
  "platform_surface": "ai_chat",
  "model": "gpt-4.3-mini",
  "query_text": "best CRM for small teams",
  "messages": [],
  "locale": "en-US",
  "geo": "US",
  "verticals": ["crm", "smb_software"],
  "intent": {
    "type": "commercial",
    "decision_phase": "compare",
    "context_summary": "User is evaluating CRM tools and narrowing down options.",
    "turn_index": 3
  },
  "allowed_formats": ["weave", "citation", "product_card"],
  "timestamp": "2025-11-14T18:22:00Z",
  "latency_budget_ms": 500,
  "user_id": "user_hash_abc123",
  "conversation_id": "conv_xyz789",
  "device_type": "desktop",
  "auth": { "nonce": "nonce_123", "sig": "sig_hmac_123abc" },
  "metadata": {
    "admesh": { "operator_relevance_score": 0.87 }
  }
}
```

## Notes
- `metadata` must be vendor-namespaced objects; operators should only write inside their namespace (e.g., `metadata.admesh`).
- `allowed_formats` lets operators constrain how creatives render for the requesting platform surface.
