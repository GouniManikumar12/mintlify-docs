{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "ContextRequest",
  "description": "Normalized request sent from an AIP operator to Brand Agents to request bids.",
  "type": "object",
  "required": [
    "context_id",
    "session_id",
    "operator_id",
    "platform_id",
    "query_text",
    "locale",
    "geo",
    "timestamp",
    "intent",
    "allowed_formats",
    "auth"
  ],
  "properties": {
    "context_id": {
      "type": "string",
      "description": "Unique ID for this auction request",
      "example": "ctx_92fA1"
    },
    "session_id": {
      "type": "string",
      "description": "Conversation/session identifier",
      "example": "sess_001"
    },
    "operator_id": {
      "type": "string",
      "description": "Identifier of the operator sending this request",
      "example": "admesh_operator"
    },
    "platform_id": {
      "type": "string",
      "description": "Identifier of the source AI platform",
      "example": "openai_chat"
    },
    "query_text": {
      "type": "string",
      "description": "User's normalized query text",
      "example": "best CRM for small teams"
    },
    "locale": {
      "type": "string",
      "pattern": "^[a-z]{2}-[A-Z]{2}$",
      "description": "User locale in BCP 47 format",
      "example": "en-US"
    },
    "geo": {
      "type": "string",
      "pattern": "^[A-Z]{2}$",
      "description": "User country code",
      "example": "US"
    },
    "verticals": {
      "type": "array",
      "description": "Normalized topical verticals identified by the operator",
      "items": { "type": "string" },
      "example": ["crm", "smb_software"]
    },
    "intent": {
      "type": "object",
      "description": "Operator-generated semantic understanding of the user's intent",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["informational", "commercial", "transactional"],
          "description": "High-level intent classification",
          "example": "commercial"
        },
        "decision_phase": {
          "type": "string",
          "enum": ["research", "compare", "decide", "act"],
          "description": "Commercial funnel decision phase",
          "example": "compare"
        },
        "context_summary": {
          "type": "string",
          "description": "Short operator-generated summary of the relevant conversation context",
          "example": "User is evaluating CRM tools and narrowing down options."
        },
        "turn_index": {
          "type": "integer",
          "minimum": 0,
          "description": "How many turns into the session the user is",
          "example": 3
        }
      }
    },
    "allowed_formats": {
      "type": "array",
      "description": "Creative formats allowed by the operator for rendering",
      "items": {
        "type": "string",
        "enum": ["weave", "citation", "product_card"]
      },
      "example": ["weave", "citation", "product_card"]
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "Timestamp when the operator created this request",
      "example": "2025-11-14T18:22:00Z"
    },
    "auth": {
      "type": "object",
      "required": ["nonce", "sig"],
      "properties": {
        "nonce": {
          "type": "string",
          "description": "One-time nonce for replay protection",
          "example": "nonce_123"
        },
        "sig": {
          "type": "string",
          "description": "HMAC signature validating this request",
          "example": "sig_hmac_123abc"
        }
      },
      "example": {
        "nonce": "nonce_123",
        "sig": "sig_hmac_123abc"
      }
    },
    "metadata": {
      "$ref": "./common.json#/definitions/extensionNamespace",
      "description": "Optional operator-defined fields or experimental values. Must be namespaced."
    }
  },
  "examples": [
    {
      "context_id": "ctx_92fA1",
      "session_id": "sess_001",
      "operator_id": "admesh_operator",
      "platform_id": "openai_chat",
      "query_text": "best CRM for small teams",
      "locale": "en-US",
      "geo": "US",
      "verticals": ["crm", "smb_software"],
      "intent": {
        "type": "commercial",
        "decision_phase": "compare",
        "context_summary": "User is evaluating CRM tools and narrowing down options.",
        "turn_index": 3
      },
      "allowed_formats": ["weave", "citation", "product_card"],
      "timestamp": "2025-11-14T18:22:00Z",
      "auth": { "nonce": "nonce_123", "sig": "sig_hmac_123abc" },
      "metadata": {
        "admesh": { "operator_relevance_score": 0.87 }
      }
    }
  ],
  "$id": "https://aip.org/schemas/context-request.json"
}
